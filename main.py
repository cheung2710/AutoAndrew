import discord
import os
import requests
import json
import io
import aiohttp
from keep_alive import keep_alive


client = discord.Client()


bad_words = ['fuck', 'shit', 'darn']


def get_quote():
  """Returns an inspirational quote from zenquotes.io."""
  response = requests.get('https://zenquotes.io/api/random')
  json_data = json.loads(response.text)
  quote = json_data[0]['q'] + "\n--" + json_data[0]['a']
  return quote


def roast(message):
  """Returns an insult with a name attached from insult.mattbas.org."""
  insult = requests.get('https://insult.mattbas.org/api/insult').text
  if message == '': return insult + "."

  name = ''
  for char in message:
    if char != ' ':
      name += char
  insult = name.capitalize() + ", you " + insult[4:]
  return insult + "."


async def get_inspirobot(message):
  """Sends an image generated by Inspirobot.
  Function body copied from Discord API docs: https://discordpy.readthedocs.io/en/stable/faq.html#how-do-i-upload-an-image"""
  my_url = requests.get('https://inspirobot.me/api?generate=true').text
  async with aiohttp.ClientSession() as session:
    async with session.get(my_url) as resp:
      if resp.status != 200:
          return await message.channel.send('Could not download file...')
      data = io.BytesIO(await resp.read())
      await message.channel.send(file = discord.File(data, 'inspirobot_image.png'))


@client.event
async def on_ready():
    print('We have logged in as {0.user}'.format(client))


@client.event
async def on_message(message):
  """All of the bot's responses to message events."""
  if message.author == client.user:
      return

  for word in bad_words:
    if word in message.content:
      author = str(message.author)
      author = author[:len(author) - 5]
      await message.channel.send(author + ", watch your fucking language!")

  if message.content.startswith('a!hello'):
    await message.channel.send('Hello!')

  elif message.content.startswith('a!quote'):
    await message.channel.send(get_quote())

  elif message.content.startswith('a!roast'):
    if len(message.content) > 6:
      insult = roast(message.content[6:])
    else:
      insult = roast('')
    await message.channel.send(insult)

  elif message.content.startswith('a!inspire'):
    await get_inspirobot(message)


keep_alive()
client.run(os.environ['DISCORD_BOT_KEY'])